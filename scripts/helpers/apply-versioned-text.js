const AUTOGENERATED_VERSION_REGEX =
    /(?<preVersionText><!-- AUTOGENERATED VERSION START -->.*?)v\d+\.\d+\.\d+(?<postVersionText>.*?<!-- AUTOGENERATED END -->)/g
const DEV_VERSION_REGEX = /^\d+.\d+.\d+-dev\.(?<gitRef>\w+)$/

function applyVersionedText(text, packageJson) {
    const versionFromPackageJson = JSON.parse(packageJson).version
    const resolvedVersion =
        versionFromPackageJson.match(DEV_VERSION_REGEX)?.groups.gitRef ||
        'v' + versionFromPackageJson
    const hasPartsToUpdate = !resolvedVersion || AUTOGENERATED_VERSION_REGEX.test(text)

    const updatedText = text.replace(
        AUTOGENERATED_VERSION_REGEX,
        `$<preVersionText>${resolvedVersion}$<postVersionText>`
    )

    return {
        hasPartsToUpdate,
        updatedText,
    }
}

module.exports = { applyVersionedText }
